<!-- pages/recycle/index.wxml -->
<view class="recycle-page">
  <scroll-view class="scroll-area" scroll-y>
    <!-- 收货地址选择 -->
    <view class="card">
      <!-- 有默认地址时显示 -->
      <view class="address-single" wx:if="{{defaultAddress}}" bindtap="selectDeliveryAddress">
        <view class="address-icon">
          <image class="location-icon" src="/assets/tabbar/地址-start.png" mode="aspectFit"></image>
        </view>
        <view class="address-content">
          <view class="address-line">
            <text class="contact-name">{{defaultAddress.contactName}}</text>
            <text class="contact-phone">{{defaultAddress.contactPhone}}</text>
          </view>
          <view class="address-detail">
            {{defaultAddress.province}}{{defaultAddress.city}}{{defaultAddress.district}}{{defaultAddress.street}} {{defaultAddress.detailAddress}}
          </view>
        </view>
        <view class="address-arrow">›</view>
      </view>
      <!-- 没有地址时显示添加按钮 -->
      <view class="address-empty" wx:else bindtap="selectDeliveryAddress">
        <text class="empty-text">去添加地址</text>
        <view class="address-arrow">›</view>
      </view>
      
      <!-- 回收点提示 -->
      <view class="recycling-point-tip" wx:if="{{selectedAddressId}}">
        <text class="tip-text success" wx:if="{{recyclingPointName}}">{{recyclingPointName}}将为您服务</text>
        <text class="tip-text error" wx:else>该地址不在服务范围内</text>
      </view>
    </view>

    <!-- 加急开关 -->
    <view class="card {{timeType === 'appointment' ? 'card-group-top' : ''}}">
      <view class="form-item checkbox-item">
        <view class="label urgent-label">
          <text>立即上门</text>
          <image class="urgent-tip-icon" src="/assets/tabbar/提醒.png" mode="aspectFit" bindtap="showUrgentTip"></image>
        </view>
        <switch checked="{{timeType === 'immediate'}}" bindchange="onImmediateSwitchChange" color="#09ccb5" />
      </view>
    </view>

    <!-- 上门时间 -->
    <view class="card card-group-bottom" wx:if="{{timeType === 'appointment'}}">
      <!-- 预约时间选择 -->
      <view class="appointment-time-selector" bindtap="showTimePicker">
        <view class="time-icon">
          <image class="clock-icon" src="/assets/tabbar/预约.png" mode="aspectFit"></image>
        </view>
        <view class="time-content">
          <view class="time-title">预约时间段</view>
          <view class="time-placeholder">{{form.startTimeStr || '请选择预约时间'}}</view>
        </view>
        <view class="time-arrow">›</view>
      </view>
    </view>

    <!-- 今日回收价格提示 -->
    <view class="card price-card" wx:if="{{todayRecyclePriceText}}">
      <view class="price-header">
        <view class="price-dot"></view>
        <text class="price-label">今日回收价格</text>
      </view>
      <view class="price-main">
        <text class="price-value">{{todayRecyclePrice}}</text>
        <text class="price-unit">元/公斤</text>
      </view>
      <view class="price-desc">
        实际结算以上门称重后的综合价格为准
      </view>
    </view>

    <!-- 回收信息 -->
    <view class="card">
      <view class="card-title">回收信息</view>
      
      <!-- 拍照留念（选填） -->
      <view class="form-item">
        <view class="label">拍照留念</view>
        <view class="image-upload-container">
          <view class="image-list">
            <view class="image-item" wx:for="{{form.images}}" wx:key="index">
              <image class="uploaded-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}" data-index="{{index}}"></image>
              <view class="delete-image-btn" bindtap="deleteImage" data-index="{{index}}">×</view>
            </view>
            <view class="upload-btn" wx:if="{{form.images.length < 9}}" bindtap="chooseImages">
              <image class="upload-placeholder-icon" src="/assets/tabbar/图片占位符.png" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>

      <!-- 备注 -->
      <view class="form-item">
        <view class="label">备注（选填）</view>
        <textarea class="textarea item-remark-textarea" placeholder="请填写回收物品相关信息" value="{{form.itemDescription}}" bindinput="onInputItemRemark" maxlength="500"></textarea>
        
        <!-- 快捷选项 -->
        <view class="quick-options">
          <view class="quick-option-item" hover-class="quick-option-item-hover" hover-start-time="0" hover-stay-time="70" wx:for="{{quickOptions}}" wx:key="index" bindtap="addQuickOption" data-text="{{item}}">
            <text>{{item}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 时间选择器弹窗 -->
    <view class="time-picker-modal" wx:if="{{showTimePickerModal}}" catchtap="hideTimePicker">
      <view class="time-picker-content" catchtap="stopPropagation">
        <view class="time-picker-header">
          <text class="time-picker-cancel" catchtap="hideTimePicker">取消</text>
          <text class="time-picker-title">选择时间段</text>
          <text class="time-picker-confirm" catchtap="confirmTimeSelection">确认</text>
        </view>
        <view class="time-picker-body">
          <view class="time-picker-left">
            <view class="time-picker-date-item {{selectedDateIndex === index ? 'active' : ''}}" 
                  wx:for="{{dateOptions}}" 
                  wx:key="index"
                  catchtap="selectDate" 
                  data-index="{{index}}">
              {{item.label}}
            </view>
          </view>
          <view class="time-picker-right">
            <block wx:if="{{timeSlotOptions.length === 0}}">
              <view class="time-picker-empty">
                <text>暂无可预约时间段</text>
              </view>
            </block>
            <block wx:else>
              <view class="time-picker-time-item {{selectedTimeSlotIndex === index ? 'active' : ''}} {{item.disabled ? 'disabled' : ''}}" 
                    wx:for="{{timeSlotOptions}}" 
                    wx:key="index"
                    catchtap="selectTimeSlot" 
                    data-index="{{index}}">
                {{item.label}}
              </view>
              <view class="time-picker-bottom-spacer"></view>
            </block>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 底部空白区域，避免内容被底部按钮遮挡 -->
    <view class="scroll-bottom-spacer"></view>
  </scroll-view>

  <!-- 提交按钮 -->
  <view class="submit-bar">
    <button class="submit-btn" bindtap="submitOrder" disabled="{{!canSubmitData || isSubmitting}}">{{isSubmitting ? '提交中...' : '提交订单'}}</button>
  </view>
</view>
