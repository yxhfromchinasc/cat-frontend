<!-- pages/express-detail/index.wxml -->
<view class="page" wx:if="{{!loading && orderDetail}}">
  <!-- 进度条 -->
  <view class="progress-section">
    <view class="progress-bar">
      <view class="progress-item {{step.status === 'completed' ? 'completed' : step.status === 'waiting' ? 'waiting' : 'disabled'}}" 
            wx:for="{{orderDetail.progressSteps}}" 
            wx:key="key"
            wx:for-index="idx"
            wx:for-item="step"
            wx:if="{{step.show}}">
        <view class="progress-dot"></view>
        <view class="progress-line {{step.lineStatus === 'completed' ? 'completed' : 'disabled'}}" 
              wx:if="{{idx < orderDetail.progressSteps.length - 1}}"></view>
      </view>
    </view>
    <view class="progress-labels">
      <view class="progress-label {{step.status === 'completed' ? 'completed' : step.status === 'waiting' ? 'waiting' : 'disabled'}}"
            wx:for="{{orderDetail.progressSteps}}" 
            wx:key="key"
            wx:for-item="step"
            wx:if="{{step.show}}">
        <text>{{step.title}}</text>
      </view>
    </view>
  </view>

  <!-- 业务员信息（进度条下方） -->
  <view class="courier-section" wx:if="{{orderDetail.courierNickname}}">
    <view class="courier-info">
      <image class="courier-avatar" src="{{orderDetail.courierAvatarUrl || '/assets/tabbar/profile.png'}}" mode="aspectFill"></image>
      <view class="courier-text">
        <view class="courier-row">
          <text class="courier-name">{{orderDetail.courierNickname}}</text>
          <view class="courier-rating">
            <text class="star" wx:for="{{orderDetail.courierRatingArray}}" wx:key="*this">★</text>
          </view>
        </view>
        <text class="courier-desc">业务员</text>
      </view>
    </view>
  </view>

  <!-- 时间线（可滚动区域） -->
  <scroll-view class="timeline-scroll" scroll-y>
    <view class="timeline-section">
    <!-- 已预约 -->
    <view class="timeline-item">
      <view class="timeline-node">
        <view class="timeline-dot completed"></view>
        <view class="timeline-line"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">已预约</text>
          <text class="timeline-time" wx:if="{{orderDetail.createdAtFormatted}}">{{orderDetail.createdAtFormatted}}</text>
        </view>
        <view class="urgent-tag" wx:if="{{orderDetail.isUrgent}}">
          <text>加急</text>
        </view>
        <view class="timeline-info">
          <view class="info-item" wx:if="{{orderDetail.stationName}}">
            <text class="info-label">取件驿站：</text>
            <text class="info-value">{{orderDetail.stationName}}</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.phoneTail}}">
            <text class="info-label">取件手机尾号：</text>
            <text class="info-value">{{orderDetail.phoneTail}}</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.pickCodes && orderDetail.pickCodes.length > 0}}">
            <text class="info-label">取件码：</text>
            <text class="info-value">{{orderDetail.pickCodes.join('、')}}</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.pickPics && orderDetail.pickPics.length > 0}}">
            <text class="info-label">取件图片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{orderDetail.pickPics}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{orderDetail.pickPics}}"></image>
            </view>
          </view>
          <view class="info-item" wx:if="{{orderDetail.itemDescription}}">
            <text class="info-label">物品备注：</text>
            <text class="info-value">{{orderDetail.itemDescription}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 待取件 -->
    <view class="timeline-item" wx:if="{{orderDetail.expressStatus >= 2}}">
      <view class="timeline-node">
        <view class="timeline-dot completed"></view>
        <view class="timeline-line" wx:if="{{orderDetail.expressStatus >= 3}}"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">待取件</text>
          <text class="timeline-time" wx:if="{{orderDetail.bandingTimeFormatted}}">{{orderDetail.bandingTimeFormatted}}</text>
        </view>
        <view class="timeline-info">
          <view class="info-item" wx:if="{{orderDetail.courierNickname}}">
            <text class="info-label">业务员：</text>
            <text class="info-value">{{orderDetail.courierNickname}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 取件成功 -->
    <view class="timeline-item" wx:if="{{orderDetail.expressStatus >= 3}}">
      <view class="timeline-node">
        <view class="timeline-dot completed"></view>
        <view class="timeline-line" wx:if="{{orderDetail.expressStatus >= 4}}"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">取件成功</text>
          <text class="timeline-time" wx:if="{{orderDetail.actPickTimeFormatted}}">{{orderDetail.actPickTimeFormatted}}</text>
        </view>
        <view class="timeline-info">
          <view class="info-item" wx:if="{{orderDetail.expressCount}}">
            <text class="info-label">取件数量：</text>
            <text class="info-value">{{orderDetail.expressCount}}件</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.expressPrice}}">
            <text class="info-label">快递费用：</text>
            <text class="info-value price">￥{{orderDetail.expressPrice}}</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.expressPics && orderDetail.expressPics.length > 0}}">
            <text class="info-label">取件照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{orderDetail.expressPics}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{orderDetail.expressPics}}"></image>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 送达 -->
    <view class="timeline-item" wx:if="{{orderDetail.expressStatus >= 4}}">
      <view class="timeline-node">
        <view class="timeline-dot completed"></view>
        <view class="timeline-line" wx:if="{{orderDetail.expressStatus >= 5}}"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">送达</text>
          <text class="timeline-time" wx:if="{{orderDetail.sendSucTimeFormatted}}">{{orderDetail.sendSucTimeFormatted}}</text>
        </view>
        <view class="timeline-info">
          <view class="info-item" wx:if="{{orderDetail.addressDetail}}">
            <text class="info-label">送达地址：</text>
            <text class="info-value">{{orderDetail.addressDetail}}</text>
          </view>
          <view class="info-item" wx:if="{{orderDetail.sendSucPics && orderDetail.sendSucPics.length > 0}}">
            <text class="info-label">送达照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{orderDetail.sendSucPics}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{orderDetail.sendSucPics}}"></image>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 支付中 -->
    <view class="timeline-item" wx:if="{{orderDetail.expressStatus === 7}}">
      <view class="timeline-node">
        <view class="timeline-dot waiting"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">支付中</text>
          <text class="timeline-time"></text>
        </view>
        <view class="timeline-info">
          <view class="info-item" wx:if="{{orderDetail.totalAmount}}">
            <text class="info-label">支付金额：</text>
            <text class="info-value price">￥{{orderDetail.totalAmount}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 已支付 -->
    <view class="timeline-item" wx:if="{{orderDetail.expressStatus === 5}}">
      <view class="timeline-node">
        <view class="timeline-dot completed"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title">已支付</text>
          <text class="timeline-time" wx:if="{{orderDetail.paidAtFormatted}}">{{orderDetail.paidAtFormatted}}</text>
        </view>
        <view class="timeline-info">
          <view class="info-item">
            <text class="info-label">订单金额：</text>
            <text class="info-value">¥{{originalAmountStr || amountStr || '0.00'}}</text>
          </view>
          <view class="info-item" wx:if="{{hasDiscount}}">
            <text class="info-label">优惠金额：</text>
            <text class="info-value discount">-¥{{discountAmountStr || '0.00'}}</text>
          </view>
          <view class="info-item" wx:if="{{couponName}}">
            <text class="info-label">使用优惠券：</text>
            <text class="info-value">{{couponName}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">实付金额：</text>
            <text class="info-value price">¥{{finalAmountStr || originalAmountStr || amountStr || '0.00'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 价格组成信息 -->
    <view class="price-breakdown" wx:if="{{orderDetail.expressBaseAmount}}">
      <view class="breakdown-title">价格组成</view>
      <view class="breakdown-item" wx:if="{{orderDetail.expressCount && orderDetail.expressPricePerItem}}">
        <text class="breakdown-label">计费基准：</text>
        <text class="breakdown-value">{{orderDetail.expressCount}}件 × ￥{{orderDetail.expressPricePerItem}}/件</text>
      </view>
      <view class="breakdown-item">
        <text class="breakdown-label">快递代取费：</text>
        <text class="breakdown-value">￥{{orderDetail.expressBaseAmount}}</text>
      </view>
      <view class="breakdown-item" wx:if="{{orderDetail.expressUrgentFee && orderDetail.expressUrgentFee > 0}}">
        <text class="breakdown-label">加急费用：</text>
        <text class="breakdown-value positive">+￥{{orderDetail.expressUrgentFee}}</text>
      </view>
      <view class="breakdown-item" wx:if="{{orderDetail.expressUrgentFeeZeroReason}}">
        <text class="breakdown-label">加急说明：</text>
        <text class="breakdown-value reason">{{orderDetail.expressUrgentFeeZeroReason}}</text>
      </view>
      <view class="breakdown-item" wx:if="{{orderDetail.expressOvertimeCompensation && orderDetail.expressOvertimeCompensation > 0}}">
        <text class="breakdown-label">超时补偿：</text>
        <text class="breakdown-value negative">-￥{{orderDetail.expressOvertimeCompensation}}</text>
      </view>
      <view class="breakdown-item" wx:if="{{orderDetail.expressCouponDiscount && orderDetail.expressCouponDiscount > 0}}">
        <text class="breakdown-label">代金券抵扣：</text>
        <text class="breakdown-value negative">-￥{{orderDetail.expressCouponDiscount}}</text>
      </view>
      <view class="breakdown-item subtotal">
        <text class="breakdown-label">应付小计：</text>
        <text class="breakdown-value price">￥{{orderDetail.expressSubtotalAmount || orderDetail.totalAmount}}</text>
      </view>
    </view>
    </view>
  </scroll-view>

  <!-- 操作按钮区域 -->
  <view class="actions-bar" wx:if="{{orderDetail.allowedActions && orderDetail.allowedActions.length > 0}}">
    <button 
      wx:for="{{orderDetail.allowedActions}}" 
      wx:key="*this"
      class="action-btn {{item === 'PAY' || item === 'CONTINUE_PAY' ? 'pay-btn' : item === 'CANCEL_PAYMENT' ? 'cancel-payment-btn' : 'cancel-btn'}}"
      bindtap="handleAction"
      data-action="{{item}}"
    >
      {{item === 'PAY' ? '立即支付' : item === 'CONTINUE_PAY' ? '继续支付' : item === 'CANCEL_PAYMENT' ? '取消支付' : item === 'CANCEL' || item === 'CANCEL_WITH_REDIRECT' ? '取消订单' : item}}
    </button>
  </view>
</view>

<view class="loading" wx:if="{{loading}}">
  <text>加载中...</text>
</view>

