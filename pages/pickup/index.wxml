<!-- pages/pickup/index.wxml -->
<view class="pickup-page">
  <scroll-view class="scroll-area" scroll-y>
  <!-- 收货地址选择 -->
    <view class="card address-card">
      <!-- 有默认地址时显示 -->
      <view class="address-single" wx:if="{{defaultAddress}}" bindtap="selectDeliveryAddress">
        <view class="address-icon">
          <image class="location-icon" src="/assets/tabbar/地址-start.png" mode="aspectFit"></image>
        </view>
        <view class="address-content">
          <view class="address-line">
            <text class="contact-name">{{defaultAddress.contactName}}</text>
            <text class="contact-phone">{{defaultAddress.contactPhone}}</text>
          </view>
          <view class="address-detail">
            {{defaultAddress.province}}{{defaultAddress.city}}{{defaultAddress.district}}{{defaultAddress.street}} {{defaultAddress.detailAddress}}
          </view>
        </view>
        <view class="address-arrow">›</view>
      </view>
      <!-- 没有地址时显示添加按钮 -->
      <view class="address-empty" wx:else bindtap="selectDeliveryAddress">
        <text class="empty-text">去添加地址</text>
        <view class="address-arrow">›</view>
      </view>
    </view>

    <!-- 取件驿站选择（地址选定后加载） -->
    <view class="card station-card">
      <picker mode="selector" range="{{stationNames}}" value="{{selectedStationIndex}}" bindchange="onStationChange">
        <view class="station-selector {{!selectedAddressId ? 'disabled' : ''}}">
          <view class="station-icon">
            <image class="station-icon-img" src="/assets/tabbar/驿站.png" mode="aspectFit"></image>
          </view>
          <view class="station-content">
            <view class="station-label">取件驿站</view>
            <view class="station-value">
              <text wx:if="{{stationNames.length > 0 && selectedStationIndex >= 0}}" class="station-name">{{stationNames[selectedStationIndex]}}</text>
              <text wx:else class="placeholder-text">{{ selectedAddressId ? '请选择取件驿站' : '请先选择收货地址' }}</text>
            </view>
          </view>
          <view class="station-arrow" wx:if="{{selectedAddressId}}">›</view>
        </view>
      </picker>
      <view class="card-tip" wx:if="{{selectedAddressId && stationNames.length === 0}}">该地址附近暂无可服务驿站</view>
    </view>

    <!-- 加急开关 -->
    <view class="card urgent-card">
      <view class="form-item checkbox-item">
        <view class="label urgent-label">
          <text class="{{isUrgentDisabled ? 'disabled-text' : ''}}">立即上门</text>
          <image class="urgent-tip-icon" src="/assets/tabbar/提醒.png" mode="aspectFit" bindtap="showUrgentTip"></image>
        </view>
        <switch checked="{{form.isUrgent}}" disabled="{{isUrgentDisabled}}" bindchange="onUrgentSwitchChange" color="#09ccb5" />
      </view>
    </view>

    <!-- 送达时间范围 -->
    <view class="card time-card" wx:if="{{!form.isUrgent}}">
      <!-- 预约时间选择 -->
      <view class="appointment-time-selector" bindtap="showTimePicker">
        <view class="time-icon">
          <image class="clock-icon" src="/assets/tabbar/预约.png" mode="aspectFit"></image>
        </view>
        <view class="time-content">
          <view class="time-title">预约时间段</view>
          <view class="time-placeholder">{{form.startTimeStr || '请选择预约时间'}}</view>
        </view>
        <view class="time-arrow">›</view>
      </view>
    </view>

    <!-- 快递计价说明 -->
    <view class="card price-card" wx:if="{{expressPricePerItem}}">
      <view class="price-header">
        <view class="price-dot"></view>
        <text class="price-label">快递计价说明</text>
      </view>
      <view class="price-main">
        <text class="price-value">{{expressPricePerItem}}</text>
        <text class="price-unit">元/件</text>
      </view>
      <view class="price-desc">
        {{expressPriceDesc}}
      </view>
    </view>

    <!-- 包裹信息 -->
    <view class="card">
      <view class="card-title">包裹信息</view>
      
      <!-- 取件手机尾号 -->
      <view class="form-item">
        <view class="label required">取件手机号后四位</view>
        <input class="input" type="number" maxlength="4" placeholder="请输入后四位" value="{{form.phoneTail}}" bindinput="onInputPhoneTail" />
      </view>

      <!-- 取件码 -->
      <view class="form-item">
        <view class="label">取件码（选填）</view>
        <textarea class="textarea pick-codes-textarea" placeholder="可填写多个，用顿号分隔" value="{{form.pickCodes}}" bindinput="onInputPickCodes" maxlength="200"></textarea>
      </view>

      <!-- 取件照片 -->
      <view class="form-item">
        <view class="label">取件码截图（选填）</view>
        <view class="image-upload-container">
          <view class="image-list">
            <view class="image-item" wx:for="{{form.pickPics}}" wx:key="index">
              <image class="uploaded-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}" data-index="{{index}}"></image>
              <view class="delete-image-btn" bindtap="deletePickPic" data-index="{{index}}">×</view>
            </view>
            <view class="upload-btn" wx:if="{{form.pickPics.length < 9}}" bindtap="choosePickPics">
              <image class="upload-placeholder-icon" src="/assets/tabbar/图片占位符.png" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>

      <!-- 物品备注 -->
      <view class="form-item">
        <view class="label">备注（选填）</view>
        <textarea class="textarea item-remark-textarea" placeholder="请填写物品相关信息，如：2件小箱子" value="{{form.itemDescription}}" bindinput="onInputItemRemark" maxlength="500"></textarea>
        
        <!-- 快捷选项 -->
        <view class="quick-options">
          <view class="quick-option-item" hover-class="quick-option-item-hover" hover-start-time="0" hover-stay-time="70" wx:for="{{quickOptions}}" wx:key="index" bindtap="addQuickOption" data-text="{{item}}">
            <text>{{item}}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 提交按钮（放在表单内部，与其他表单信息同一层级） -->
    <view class="card submit-card">
      <!-- 未完成项提示 -->
      <view class="submit-tip" wx:if="{{submitTip}}">{{submitTip}}</view>
      <button class="submit-btn" bindtap="onSubmit" disabled="{{!canSubmitData || isSubmitting || showTimePickerModal}}">{{isSubmitting ? '提交中...' : '提交订单'}}</button>
    </view>
    
    <!-- 底部安全空白区域 -->
    <view class="safe-area-bottom"></view>
    
    <!-- 时间选择器弹窗（共用组件） -->
    <time-picker-modal
      visible="{{showTimePickerModal}}"
      dateOptions="{{dateOptions}}"
      timeSlotOptions="{{timeSlotOptions}}"
      selectedDateIndex="{{selectedDateIndex}}"
      selectedTimeSlotIndex="{{selectedTimeSlotIndex}}"
      bind:close="hideTimePicker"
      bind:selectdate="selectDate"
      bind:selecttimeslot="selectTimeSlot"
      bind:confirm="confirmTimeSelection"
    />
  </scroll-view>
</view>
