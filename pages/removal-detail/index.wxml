<view class="page" wx:if="{{!loading && orderDetail}}">
  <!-- 进度条 -->
  <view class="progress-section" wx:if="{{orderDetail.progressSteps && orderDetail.progressSteps.length > 0}}">
    <view class="progress-wrapper">
      <view class="progress-nodes">
        <view class="progress-node {{step.status === 'completed' ? 'completed' : step.status === 'waiting' ? 'active' : 'pending'}}"
              wx:for="{{orderDetail.progressSteps}}"
              wx:key="key"
              wx:for-item="step"
              wx:for-index="stepIndex"
              wx:if="{{step.show}}">
          <view class="node-container">
            <view class="node-line {{stepIndex > 0 && orderDetail.progressSteps[stepIndex - 1].status === 'completed' ? 'completed' : 'pending'}}" wx:if="{{stepIndex > 0}}"></view>
            <view class="node-dot"></view>
            <view class="node-line {{step.status === 'completed' ? 'completed' : 'pending'}}" wx:if="{{stepIndex < orderDetail.progressSteps.length - 1}}"></view>
          </view>
          <view class="node-label">{{step.title}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 小哥信息 -->
  <view class="courier-section" wx:if="{{orderDetail.courierNickname}}">
    <view class="courier-info">
      <image class="courier-avatar" src="{{orderDetail.courierAvatarUrl || '/assets/tabbar/profile.png'}}" mode="aspectFill"></image>
      <view class="courier-text">
        <text class="courier-name">{{orderDetail.courierNickname}}</text>
        <text class="courier-desc">清运小哥</text>
      </view>
    </view>
    <view class="courier-actions" wx:if="{{orderDetail.courierPhone || orderDetail.courierId}}">
      <view class="phone-btn" wx:if="{{orderDetail.courierPhone}}" bindtap="callCourier" data-phone="{{orderDetail.courierPhone}}">
        <image class="phone-icon" src="/assets/tabbar/call.png" mode="aspectFit" />
      </view>
      <view class="contact-btn-small" wx:if="{{orderDetail.courierId}}" bindtap="onContactTap">
        <image class="contact-icon-small" src="/assets/tabbar/会话.svg" mode="aspectFit" />
      </view>
    </view>
  </view>

  <!-- 订单信息 -->
  <view class="info-section">
    <view class="info-row">
      <text class="info-label">订单号</text>
      <text class="info-value">{{orderDetail.orderNo}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">状态</text>
      <text class="info-value">{{orderDetail.removalStatusDesc}}</text>
    </view>
    <view class="info-row" wx:if="{{orderDetail.addressDetail}}">
      <text class="info-label">地址</text>
      <text class="info-value">{{orderDetail.addressDetail}}</text>
    </view>
    <view class="info-row" wx:if="{{orderDetail.startTime && orderDetail.endTime}}">
      <text class="info-label">预约时间</text>
      <text class="info-value">{{orderDetail.startTime}} - {{orderDetail.endTime}}</text>
    </view>
    <view class="info-row" wx:if="{{orderDetail.actualPrice != null && (orderDetail.removalStatus === 4 || orderDetail.removalStatus === 5)}}">
      <text class="info-label">实际费用</text>
      <text class="info-value price">¥{{orderDetail.actualPriceStr}}</text>
    </view>
  </view>

  <!-- 时间线（对齐快递详情粒度） -->
  <scroll-view class="timeline-scroll" scroll-y wx:if="{{orderDetail.timeline && orderDetail.timeline.length > 0}}">
    <view class="timeline-section">
      <view class="timeline-item {{event.status === 'cancelled' ? 'cancelled' : ''}}" wx:for="{{orderDetail.timeline}}" wx:key="type" wx:for-index="idx" wx:for-item="event">
        <view class="timeline-node">
          <view class="timeline-dot {{event.status === 'completed' ? 'completed' : event.status === 'waiting' ? 'waiting' : event.status === 'cancelled' ? 'cancelled' : 'disabled'}}"></view>
          <view class="timeline-line" wx:if="{{idx < orderDetail.timeline.length - 1}}"></view>
        </view>
        <view class="timeline-content">
          <view class="timeline-header">
            <text class="timeline-title {{event.status === 'cancelled' ? 'cancelled' : ''}}">{{event.title}}</text>
            <text class="timeline-time" wx:if="{{event.timeFormatted}}">{{event.timeFormatted}}</text>
          </view>
          <view class="urgent-tag" wx:if="{{event.displayType === 'CREATED' && event.data.isUrgent}}">
            <text>加急</text>
          </view>
          <view class="timeline-info">
            <!-- CREATED 用户下单 -->
            <view class="info-item" wx:if="{{event.displayType === 'CREATED' && event.data.orderNo}}">
              <text class="info-label">订单号：</text>
              <text class="info-value">{{event.data.orderNo}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'CREATED' && event.data.removalPointName}}">
              <text class="info-label">清运点：</text>
              <text class="info-value">{{event.data.removalPointName}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'CREATED' && event.data.addressDetail}}">
              <text class="info-label">服务地址：</text>
              <text class="info-value">{{event.data.addressDetail}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'CREATED' && (event.data.timeRangeFormatted || (event.data.startTime && event.data.endTime))}}">
              <text class="info-label">预约时间：</text>
              <text class="info-value">{{event.data.timeRangeFormatted || (event.data.startTime + ' - ' + event.data.endTime)}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'CREATED' && event.data.itemDescription}}">
              <text class="info-label">物品描述：</text>
              <text class="info-value">{{event.data.itemDescription}}</text>
            </view>
            <!-- BANDING 小哥接单 -->
            <view class="info-item" wx:if="{{event.displayType === 'BANDING' && event.data.courierNickname}}">
              <text class="info-label">清运小哥：</text>
              <text class="info-value">{{event.data.courierNickname}}</text>
            </view>
            <!-- QUOTE 接受报价 -->
            <view class="info-item" wx:if="{{event.displayType === 'QUOTE' && event.data.desc}}">
              <text class="info-label">说明：</text>
              <text class="info-value">{{event.data.desc}}</text>
            </view>
            <!-- COMPLETE_SERVICE 服务完成 -->
            <view class="info-item" wx:if="{{event.displayType === 'COMPLETE_SERVICE' && event.data.desc}}">
              <text class="info-label">说明：</text>
              <text class="info-value">{{event.data.desc}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'COMPLETE_SERVICE' && event.data.actualPrice != null}}">
              <text class="info-label">实际费用：</text>
              <text class="info-value price">¥{{event.data.actualPrice}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'COMPLETE_SERVICE' && event.data.images && event.data.images.length > 0}}">
              <text class="info-label">完成照片：</text>
              <view class="image-list">
                <image class="info-image" wx:for="{{event.data.images}}" wx:key="*this" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-url="{{item}}" data-urls="{{event.data.images}}"></image>
              </view>
            </view>
            <!-- START_PAY / ABORT_PAY -->
            <view class="info-item" wx:if="{{(event.displayType === 'START_PAY' || event.displayType === 'ABORT_PAY') && event.data.desc}}">
              <text class="info-value">{{event.data.desc}}</text>
            </view>
            <!-- PAID 支付成功 -->
            <view class="info-item" wx:if="{{event.displayType === 'PAID' && event.data.actualAmount}}">
              <text class="info-label">实付金额：</text>
              <text class="info-value price">¥{{event.data.actualAmount}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'PAID' && event.data.desc}}">
              <text class="info-value">{{event.data.desc}}</text>
            </view>
            <!-- CANCELLED 订单取消 -->
            <view class="info-item" wx:if="{{event.displayType === 'CANCELLED' && event.data.operator}}">
              <text class="info-label">操作人：</text>
              <text class="info-value">{{event.data.operator}}</text>
            </view>
            <view class="info-item" wx:if="{{event.displayType === 'CANCELLED' && event.data.reason}}">
              <text class="info-label">取消原因：</text>
              <text class="info-value">{{event.data.reason}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 操作按钮 -->
  <view class="actions-bar" wx:if="{{orderDetail.allowedActionLabels && orderDetail.allowedActionLabels.length > 0}}">
    <button wx:for="{{orderDetail.allowedActionLabels}}"
            wx:key="code"
            class="action-btn {{item.code === 'CANCEL' || item.code === 'CANCEL_PAYMENT' ? 'cancel-btn' : 'primary-btn'}}"
            bindtap="handleAction"
            data-action="{{item.code}}">{{item.label}}</button>
  </view>
</view>

<view class="loading" wx:if="{{loading}}">
  <text>加载中...</text>
</view>
