<!-- pages/payment/index.wxml -->
<view class="page" wx:if="{{!loading && paymentDetail}}">
  <!-- 订单信息 -->
  <view class="section order-info">
    <view class="section-title">订单信息</view>
    <view class="order-item">
      <text class="label">订单号：</text>
      <text class="value">{{orderNo}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.stationName}}">
      <text class="label">取件驿站：</text>
      <text class="value">{{paymentDetail.displayInfo.stationName}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.addressDetail}}">
      <text class="label">{{paymentDetail.serviceType === 2 ? '送达地址' : paymentDetail.serviceType === 3 ? '回收地址' : '地址'}}：</text>
      <text class="value">{{paymentDetail.displayInfo.addressDetail}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.itemDescription}}">
      <text class="label">物品描述：</text>
      <text class="value">{{paymentDetail.displayInfo.itemDescription}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.expressCount}}">
      <text class="label">取件数量：</text>
      <text class="value">{{paymentDetail.displayInfo.expressCount}}件</text>
    </view>
  </view>

  <!-- 金额明细 -->
  <view class="section amount-info">
    <view class="section-title">金额明细</view>
    <view class="amount-item">
      <text class="label">订单金额：</text>
      <text class="value">¥{{originalAmountStr || '0.00'}}</text>
    </view>
    <view class="amount-item" wx:if="{{hasDiscount}}">
      <text class="label">优惠金额：</text>
      <text class="value discount">-¥{{discountAmountStr || '0.00'}}</text>
    </view>
    <view class="amount-item final">
      <text class="label">实付金额：</text>
      <text class="value final-amount">¥{{finalAmountStr || '0.00'}}</text>
    </view>
  </view>

  <!-- 优惠券：继续支付也展示只读已选券 -->
  <view class="section coupon-section" wx:if="{{couponAllowed || (paymentDetail && paymentDetail.continueMode && selectedCoupon)}}">
    <view class="section-title">优惠券</view>
    <view class="coupon-selector" bindtap="toggleCouponPicker">
      <view class="coupon-info" wx:if="{{selectedCoupon}}">
        <view class="coupon-left-small">
          <view class="coupon-type-badge-small" style="background: {{selectedCoupon.typeColor}}">
            <text class="coupon-type-icon-small">{{selectedCoupon.typeIcon}}</text>
            <text class="coupon-type-text-small">{{selectedCoupon.typeText}}</text>
          </view>
          <text class="coupon-value-small">{{selectedCoupon.mainValue}}</text>
        </view>
        <view class="coupon-right-small">
          <text class="coupon-name-small">{{selectedCoupon.name || '优惠券'}}</text>
          <text class="coupon-condition-small">{{selectedCoupon.conditionText}}</text>
        </view>
        <text class="remove-coupon" wx:if="{{!paymentDetail || !paymentDetail.continueMode}}" catchtap="removeCoupon" stop-propagation>不使用</text>
      </view>
      <view class="coupon-placeholder" wx:else>
        <view class="coupon-placeholder-left">
          <text>选择优惠券（可选）</text>
          <text class="coupon-count" wx:if="{{availableCoupons.length > 0}}">{{availableCoupons.length}}张可用</text>
        </view>
      </view>
      <text class="arrow" wx:if="{{couponAllowed}}">›</text>
    </view>
    
    <!-- 优惠券列表（下拉选择） -->
    <view class="coupon-list" wx:if="{{showCouponPicker && couponAllowed}}">
      <view 
        class="coupon-item" 
        hover-class="coupon-card-hover"
        hover-start-time="0"
        hover-stay-time="70"
        wx:for="{{availableCoupons}}" 
        wx:key="id"
        bindtap="selectCoupon"
        data-coupon="{{item}}"
      >
        <view class="coupon-card" style="border-left: 4rpx solid {{item.typeColor}}">
          <view class="coupon-left">
            <view class="coupon-type-badge" style="background: {{item.typeColor}}">
              <text class="coupon-type-icon">{{item.typeIcon}}</text>
              <text class="coupon-type-text">{{item.typeText}}</text>
            </view>
            <view class="coupon-main-value">{{item.mainValue}}</view>
          </view>
          <view class="coupon-right">
            <view class="coupon-name">{{item.name || '优惠券'}}</view>
            <view class="coupon-condition">{{item.conditionText}}</view>
          </view>
        </view>
      </view>
      <view class="empty-coupon" wx:if="{{availableCoupons.length === 0}}">
        <text>暂无可用的优惠券</text>
      </view>
    </view>
  </view>

  <!-- 支付方式 -->
  <view class="section payment-section">
    <view class="section-title">支付方式</view>
    <view 
      class="payment-item {{selectedPaymentMethod === item.code ? 'selected' : ''}}"
      wx:for="{{paymentMethods}}"
      wx:key="code"
      bindtap="selectPaymentMethod"
      data-method="{{item}}"
    >
      <view class="payment-info">
        <text class="payment-icon">{{item.icon}}</text>
        <text class="payment-name">{{item.name}}</text>
      </view>
      <view class="payment-balance" wx:if="{{item.code === 4}}">
        <text>余额：¥{{userBalanceStr || '0.00'}}</text>
      </view>
      <view class="payment-check" wx:if="{{selectedPaymentMethod === item.code}}">
        <text class="check-icon">✓</text>
      </view>
    </view>
  </view>

  <!-- 支付按钮 -->
  <view class="payment-bar">
  <view class="payment-summary">
    <view class="summary-main">
      <text class="summary-label">合计：</text>
      <text class="summary-amount">¥{{finalAmountStr || '0.00'}}</text>
    </view>
    <view class="summary-remain" wx:if="{{paymentDetail && paymentDetail.continueMode && payRemainStr}}">
      <text class="summary-remain-label">剩余：</text>
      <text class="summary-remain-time">{{payRemainStr}}</text>
    </view>
  </view>
    <button class="pay-btn" bindtap="onPay" disabled="{{finalAmount < 0}}">
      确认支付
    </button>
    <button class="pay-btn" wx:if="{{paymentDetail && paymentDetail.continueMode}}" bindtap="onCancelPayment" style="background:#f5f5f5;color:#333;">
      取消本次支付
    </button>
  </view>
</view>

<view class="loading" wx:if="{{loading}}">
  <text>加载中...</text>
</view>


<!-- 自定义倒计时加载（覆盖层） -->
<view wx:if="{{showPaymentLoading}}" style="position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); z-index: 9999; display: flex; align-items: center; justify-content: center;">
  <view style="background: #ffffff; padding: 32rpx 40rpx; border-radius: 16rpx; min-width: 480rpx; display: flex; flex-direction: column; align-items: center;">
    <view style="width: 72rpx; height: 72rpx; border: 6rpx solid #eaeaea; border-top-color: #07c160; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20rpx;"></view>
    <text style="font-size: 28rpx; color: #333;">确认支付结果中…</text>
    <text style="font-size: 24rpx; color: #999; margin-top: 8rpx;">约{{paymentLoadingCountdown}}秒</text>
  </view>
</view>

<!-- 简易内联动画（小程序不支持 @keyframes 内联，使用占位类名，留待页面 wxss 定义） -->

