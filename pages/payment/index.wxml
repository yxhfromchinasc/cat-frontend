<!-- pages/payment/index.wxml -->
<view class="page" wx:if="{{!loading && paymentDetail}}">
  <!-- 订单信息 -->
  <view class="section order-info">
    <view class="section-title">订单信息</view>
    <view class="order-item">
      <text class="label">订单号：</text>
      <text class="value">{{orderNo}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.stationName}}">
      <text class="label">取件驿站：</text>
      <text class="value">{{paymentDetail.displayInfo.stationName}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.addressDetail}}">
      <text class="label">{{paymentDetail.serviceType === 2 ? '送达地址' : paymentDetail.serviceType === 3 ? '回收地址' : '地址'}}：</text>
      <text class="value">{{paymentDetail.displayInfo.addressDetail}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.itemDescription}}">
      <text class="label">物品描述：</text>
      <text class="value">{{paymentDetail.displayInfo.itemDescription}}</text>
    </view>
    <view class="order-item" wx:if="{{paymentDetail.displayInfo && paymentDetail.displayInfo.expressCount}}">
      <text class="label">取件数量：</text>
      <text class="value">{{paymentDetail.displayInfo.expressCount}}件</text>
    </view>
  </view>

  <!-- 金额明细 -->
  <view class="section amount-info">
    <view class="section-title">金额明细</view>
    <view class="amount-item">
      <text class="label">订单金额：</text>
      <text class="value">¥{{originalAmountStr || '0.00'}}</text>
    </view>
    <view class="amount-item" wx:if="{{selectedCoupon && couponDiscount > 0}}">
      <text class="label">优惠金额：</text>
      <text class="value discount">-¥{{couponDiscount.toFixed ? couponDiscount.toFixed(2) : couponDiscount}}</text>
    </view>
    <view class="amount-item final">
      <text class="label">实付金额：</text>
      <text class="value final-amount">¥{{finalAmountStr || '0.00'}}</text>
    </view>
  </view>

  <!-- 优惠券选择 -->
  <view class="section coupon-section" wx:if="{{couponAllowed}}">
    <view class="section-title">优惠券</view>
    <view class="coupon-selector" bindtap="toggleCouponPicker">
      <view class="coupon-info" wx:if="{{selectedCoupon}}">
        <view class="coupon-left-small">
          <view class="coupon-type-badge-small" style="background: {{selectedCoupon.typeColor}}">
            <text class="coupon-type-icon-small">{{selectedCoupon.typeIcon}}</text>
            <text class="coupon-type-text-small">{{selectedCoupon.typeText}}</text>
          </view>
          <text class="coupon-value-small">{{selectedCoupon.mainValue}}</text>
        </view>
        <view class="coupon-right-small">
          <text class="coupon-name-small">{{selectedCoupon.name || '优惠券'}}</text>
          <text class="coupon-condition-small">{{selectedCoupon.conditionText}}</text>
        </view>
        <text class="remove-coupon" catchtap="removeCoupon" stop-propagation>不使用</text>
      </view>
      <view class="coupon-placeholder" wx:else>
        <view class="coupon-placeholder-left">
          <text>选择优惠券（可选）</text>
          <text class="coupon-count" wx:if="{{availableCoupons.length > 0}}">{{availableCoupons.length}}张可用</text>
        </view>
      </view>
      <text class="arrow">›</text>
    </view>
    
    <!-- 优惠券列表（下拉选择） -->
    <view class="coupon-list" wx:if="{{showCouponPicker}}">
      <view 
        class="coupon-item" 
        wx:for="{{availableCoupons}}" 
        wx:key="id"
        bindtap="selectCoupon"
        data-coupon="{{item}}"
      >
        <view class="coupon-card" style="border-left: 4rpx solid {{item.typeColor}}">
          <view class="coupon-left">
            <view class="coupon-type-badge" style="background: {{item.typeColor}}">
              <text class="coupon-type-icon">{{item.typeIcon}}</text>
              <text class="coupon-type-text">{{item.typeText}}</text>
            </view>
            <view class="coupon-main-value">{{item.mainValue}}</view>
          </view>
          <view class="coupon-right">
            <view class="coupon-name">{{item.name || '优惠券'}}</view>
            <view class="coupon-condition">{{item.conditionText}}</view>
          </view>
        </view>
      </view>
      <view class="empty-coupon" wx:if="{{availableCoupons.length === 0}}">
        <text>暂无可用的优惠券</text>
      </view>
    </view>
  </view>

  <!-- 支付方式 -->
  <view class="section payment-section">
    <view class="section-title">支付方式</view>
    <view 
      class="payment-item {{selectedPaymentMethod === item.code ? 'selected' : ''}}"
      wx:for="{{paymentMethods}}"
      wx:key="code"
      bindtap="selectPaymentMethod"
      data-method="{{item}}"
    >
      <view class="payment-info">
        <text class="payment-icon">{{item.icon}}</text>
        <text class="payment-name">{{item.name}}</text>
      </view>
      <view class="payment-balance" wx:if="{{item.code === 4}}">
        <text>余额：¥{{userBalanceStr || '0.00'}}</text>
      </view>
      <view class="payment-check" wx:if="{{selectedPaymentMethod === item.code}}">
        <text class="check-icon">✓</text>
      </view>
    </view>
  </view>

  <!-- 支付按钮 -->
  <view class="payment-bar">
    <view class="payment-summary">
      <text class="summary-label">合计：</text>
      <text class="summary-amount">¥{{finalAmountStr || '0.00'}}</text>
    </view>
    <button class="pay-btn" bindtap="onPay" disabled="{{finalAmount <= 0}}">
      确认支付
    </button>
  </view>
</view>

<view class="loading" wx:if="{{loading}}">
  <text>加载中...</text>
</view>

