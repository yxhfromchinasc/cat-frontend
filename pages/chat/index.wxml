<!-- pages/chat/index.wxml -->
<view class="page">
  <!-- æ‚¬æµ®è®¢å•ä¿¡æ¯æ°”æ³¡ï¼šç±»å‹ã€é¢„çº¦æ—¶é—´ã€åœ°å€ï¼Œç‚¹å‡»è·³è½¬è®¢å•è¯¦æƒ…ï¼ˆç”¨æˆ·ç«¯ä¸å±•ç¤ºæ‰‹æœºå°¾å·ï¼‰ -->
  <view class="order-bubble-bar" wx:if="{{conversation && conversation.orderNo}}" bindtap="goToOrderDetail">
    <view class="order-bubble">
      <view class="order-bubble-content">
        <view class="order-bubble-main">
          <text class="order-bubble-type">{{conversation.orderServiceType === 3 ? 'å›æ”¶' : 'å¿«é€’'}}</text>
          <text class="order-bubble-time" wx:if="{{conversation.orderAppointmentTime}}">{{conversation.orderAppointmentTime}}</text>
        </view>
        <view class="order-bubble-addr" wx:if="{{conversation.orderAddressBrief}}">{{conversation.orderAddressBrief}}</view>
      </view>
      <text class="order-bubble-arrow">â€º</text>
    </view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    id="message-list"
    class="message-list" 
    scroll-y="{{true}}"
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    bindscroll="onScroll"
    bindscrolltolower="onReachBottom">
    
    <view class="message-item" wx:for="{{messageList}}" wx:key="id" wx:for-item="msg">
      <!-- æ¶ˆæ¯æ°”æ³¡ -->
      <!-- å¯¹æ–¹æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œå†…å®¹åœ¨å³ -->
      <view class="message-bubble other" wx:if="{{!msg.isMine}}">
        <image 
          class="avatar" 
          src="{{conversation.otherUser.avatarUrl || '/assets/tabbar/profile.png'}}" 
          mode="aspectFill"></image>
        
        <view class="content-wrapper">
          <view class="content">
            <!-- æ–‡æœ¬æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 1}}" class="text-message">
              <text>{{msg.content}}</text>
            </view>
            
            <!-- å›¾ç‰‡æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 2}}" class="image-message">
              <image 
                src="{{msg.imageUrl}}" 
                mode="widthFix"
                bindtap="previewImage"
                data-url="{{msg.imageUrl}}"></image>
            </view>
            
            <!-- ä½ç½®æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 3}}" class="location-message" bindtap="openLocation" 
                  data-latitude="{{msg.locationLatitude}}" 
                  data-longitude="{{msg.locationLongitude}}" 
                  data-address="{{msg.locationAddress}}">
              <view class="location-icon">ğŸ“</view>
              <view class="location-info">
                <text class="location-name">{{msg.locationAddress || 'ä½ç½®'}}</text>
                <text class="location-hint">ç‚¹å‡»æŸ¥çœ‹ä½ç½®</text>
              </view>
            </view>
          </view>
          <!-- æ¶ˆæ¯æ—¶é—´ -->
          <view class="message-time-wrapper" wx:if="{{msg.timeFormatted}}">
            <text class="message-time">{{msg.timeFormatted}}</text>
          </view>
        </view>
      </view>
      
      <!-- æˆ‘çš„æ¶ˆæ¯ï¼šå†…å®¹åœ¨å·¦ï¼Œå¤´åƒåœ¨å³ -->
      <view class="message-bubble mine" wx:if="{{msg.isMine}}">
        <view class="content-wrapper">
          <view class="content">
            <!-- æ–‡æœ¬æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 1}}" class="text-message">
              <text>{{msg.content}}</text>
            </view>
            
            <!-- å›¾ç‰‡æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 2}}" class="image-message">
              <image 
                src="{{msg.imageUrl}}" 
                mode="widthFix"
                bindtap="previewImage"
                data-url="{{msg.imageUrl}}"></image>
            </view>
            
            <!-- ä½ç½®æ¶ˆæ¯ -->
            <view wx:if="{{msg.messageType === 3}}" class="location-message" bindtap="openLocation" 
                  data-latitude="{{msg.locationLatitude}}" 
                  data-longitude="{{msg.locationLongitude}}" 
                  data-address="{{msg.locationAddress}}">
              <view class="location-icon">ğŸ“</view>
              <view class="location-info">
                <text class="location-name">{{msg.locationAddress || 'ä½ç½®'}}</text>
                <text class="location-hint">ç‚¹å‡»æŸ¥çœ‹ä½ç½®</text>
              </view>
            </view>
          </view>
          <!-- æ¶ˆæ¯æ—¶é—´å’Œå·²è¯»çŠ¶æ€ -->
          <view class="message-time-wrapper" wx:if="{{msg.timeFormatted}}">
            <text class="message-time">{{msg.timeFormatted}}</text>
            <text class="read-status" wx:if="{{msg.isMine}}">{{msg.isRead ? 'å·²è¯»' : 'æœªè¯»'}}</text>
          </view>
        </view>
        
        <image 
          class="avatar" 
          src="{{currentUserAvatar || '/assets/tabbar/profile.png'}}" 
          mode="aspectFill"></image>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:if="{{!loading && messageList.length === 0}}">
      <text>æš‚æ— æ¶ˆæ¯</text>
    </view>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="loading-more" wx:if="{{loading && !hasMore}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </scroll-view>
  
  <!-- è¾“å…¥å·¥å…·æ  -->
  <view class="input-bar" wx:if="{{conversation && conversation.isClosed !== 1}}">
    <!-- è¾“å…¥æ  -->
    <view class="input-row">
      <textarea 
        class="input" 
        placeholder="è¾“å…¥æ¶ˆæ¯..." 
        value="{{inputValue}}"
        bindinput="onInput"
        confirm-type="send"
        bindconfirm="sendTextMessage"
        auto-height="{{true}}"
        maxlength="{{500}}"
        show-confirm-bar="{{false}}"
        cursor-spacing="{{0}}"></textarea>
      <!-- æœ‰è¾“å…¥å†…å®¹æ—¶æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œå¦åˆ™æ˜¾ç¤ºå±•å¼€/æ”¶èµ·æŒ‰é’® -->
      <view 
        class="add-btn {{showMoreTools ? 'collapsed' : ''}}" 
        wx:if="{{!hasInput}}"
        bindtap="toggleMoreTools">
        <image class="add-icon" src="{{showMoreTools ? '/assets/tabbar/å‡å·.svg' : '/assets/tabbar/å±•å¼€.svg'}}" mode="aspectFit"></image>
      </view>
      <button 
        class="send-btn" 
        wx:if="{{hasInput}}"
        bindtap="sendTextMessage" 
        disabled="{{sending}}">
        <image class="send-icon" src="/assets/tabbar/å‘é€.svg" mode="aspectFit"></image>
      </button>
    </view>
    
    <!-- æ‰©å±•å·¥å…·æ ï¼ˆç‚¹å‡»åŠ å·åå±•å¼€ï¼‰ -->
    <view class="more-tools {{showMoreTools ? 'show' : ''}}">
      <view class="tool-item" bindtap="chooseImage">
        <view class="tool-icon-wrapper">
          <image class="tool-icon" src="/assets/tabbar/ç…§ç‰‡.png" mode="aspectFit"></image>
        </view>
        <text class="tool-label">ç…§ç‰‡</text>
      </view>
      <view class="tool-item" bindtap="chooseLocation">
        <view class="tool-icon-wrapper">
          <image class="tool-icon" src="/assets/tabbar/å®šä½.png" mode="aspectFit"></image>
        </view>
        <text class="tool-label">ä½ç½®</text>
      </view>
    </view>
  </view>
  
  <!-- ä¼šè¯å·²å…³é—­æç¤º -->
  <view class="closed-tip" wx:if="{{conversation && conversation.isClosed === 1}}">
    <text>è®¢å•å·²ç»“æŸï¼Œæ— æ³•å‘é€æ¶ˆæ¯</text>
  </view>
  
  <!-- æ–°æ¶ˆæ¯æç¤ºæ°”æ³¡ -->
  <view 
    class="new-message-tip {{showNewMessageTip ? 'show' : ''}}" 
    wx:if="{{showNewMessageTip && newMessageCount > 0}}"
    bindtap="onNewMessageTipTap">
    <text class="new-message-text">æ–°æ¶ˆæ¯ {{newMessageCount}}</text>
  </view>
  
  <!-- å›¾ç‰‡é¢„è§ˆç¡®è®¤å¼¹çª— -->
  <view class="image-preview-modal" wx:if="{{showImagePreview}}" bindtap="closeImagePreview">
    <view class="image-preview-popup" catchtap="stopPropagation">
      <view class="image-preview-header">
        <text class="image-preview-title">é¢„è§ˆå›¾ç‰‡</text>
        <text class="image-preview-close" bindtap="closeImagePreview">Ã—</text>
      </view>
      <view class="image-preview-content">
        <image class="image-preview-img" src="{{previewImagePath}}" mode="aspectFit"></image>
      </view>
      <view class="image-preview-footer">
        <button class="image-preview-btn cancel-btn" bindtap="closeImagePreview">å–æ¶ˆ</button>
        <button class="image-preview-btn confirm-btn" bindtap="confirmSendImage">å‘é€</button>
      </view>
    </view>
  </view>
</view>
