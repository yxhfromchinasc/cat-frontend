<!-- pages/recycling-detail/index.wxml -->
<view class="page" wx:if="{{!loading && orderDetail}}">
  <!-- 进度条 -->
  <view class="progress-section">
    <view class="progress-wrapper">
      <view class="progress-nodes">
        <view class="progress-node {{step.status === 'completed' ? 'completed' : step.status === 'waiting' ? 'active' : 'pending'}}" 
              wx:for="{{orderDetail.progressSteps}}" 
              wx:key="key"
              wx:for-item="step"
              wx:for-index="stepIndex"
              wx:if="{{step.show}}">
          <view class="node-container">
            <view class="node-line {{stepIndex > 0 && orderDetail.progressSteps[stepIndex - 1].status === 'completed' ? 'completed' : 'pending'}}" wx:if="{{stepIndex > 0}}"></view>
            <view class="node-dot"></view>
            <view class="node-line {{step.status === 'completed' ? 'completed' : 'pending'}}" wx:if="{{stepIndex < orderDetail.progressSteps.length - 1}}"></view>
          </view>
          <view class="node-label">{{step.title}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 回收员信息（进度条下方） -->
  <view class="courier-section" wx:if="{{orderDetail.recyclerNickname}}">
    <view class="courier-info">
      <image class="courier-avatar" src="{{orderDetail.recyclerAvatarUrl || '/assets/tabbar/profile.png'}}" mode="aspectFill"></image>
      <view class="courier-text">
        <view class="courier-row">
          <text class="courier-name">{{orderDetail.recyclerNickname}}</text>
          <view class="courier-rating">
            <text class="star" wx:for="{{orderDetail.recyclerRatingArray}}" wx:key="*this">★</text>
          </view>
        </view>
        <text class="courier-desc">回收员</text>
      </view>
    </view>
    <view class="courier-actions" wx:if="{{orderDetail.recyclerPhone || orderDetail.recyclerId}}">
      <view class="phone-btn" wx:if="{{orderDetail.recyclerPhone}}" bindtap="callRecycler" data-phone="{{orderDetail.recyclerPhone}}">
        <image class="phone-icon" src="/assets/tabbar/call.png" mode="aspectFit" />
      </view>
      <view class="contact-btn-small" wx:if="{{orderDetail.recyclerId}}" bindtap="onContactTap">
        <image class="contact-icon-small" src="/assets/tabbar/会话.svg" mode="aspectFit" />
      </view>
    </view>
  </view>

  <!-- 时间线（可滚动区域） -->
  <scroll-view class="timeline-scroll" scroll-y>
    <view class="timeline-section">
    <!-- 使用后端返回的时间线数据动态渲染 -->
    <view class="timeline-item {{event.status === 'cancelled' ? 'cancelled' : ''}}" wx:for="{{orderDetail.timeline}}" wx:key="type" wx:for-index="idx" wx:for-item="event">
      <view class="timeline-node">
        <view class="timeline-dot {{event.status === 'completed' ? 'completed' : event.status === 'waiting' ? 'waiting' : event.status === 'cancelled' ? 'cancelled' : 'disabled'}}"></view>
        <view class="timeline-line" wx:if="{{idx < orderDetail.timeline.length - 1}}"></view>
      </view>
      <view class="timeline-content">
        <view class="timeline-header">
          <text class="timeline-title {{event.status === 'cancelled' ? 'cancelled' : ''}}">{{event.title}}</text>
          <text class="timeline-time" wx:if="{{event.timeFormatted}}">{{event.timeFormatted}}</text>
        </view>
        <!-- 加急标签（仅CREATED事件显示） -->
        <view class="urgent-tag" wx:if="{{event.type === 'CREATED' && event.data.isUrgent}}">
          <text>加急</text>
        </view>
        <view class="timeline-info">
          <!-- CREATED事件的数据 -->
          <view class="info-item" wx:if="{{event.type === 'CREATED' && orderDetail.orderNo}}">
            <text class="info-label">订单号：</text>
            <text class="info-value">{{orderDetail.orderNo}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'CREATED' && event.data.addressDetail}}">
            <text class="info-label">回收地址：</text>
            <text class="info-value">{{event.data.addressDetail}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'CREATED' && event.data.startTime && event.data.endTime}}">
            <text class="info-label">预约时间：</text>
            <text class="info-value">{{event.data.timeRangeFormatted || (event.data.startTime + ' - ' + event.data.endTime)}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'CREATED' && event.data.estWeight}}">
            <text class="info-label">预估重量：</text>
            <text class="info-value">{{event.data.estWeight}}kg</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'CREATED' && event.data.itemDescription}}">
            <text class="info-label">物品描述：</text>
            <text class="info-value">{{event.data.itemDescription}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'CREATED' && event.data.images && event.data.images.length > 0}}">
            <text class="info-label">回收照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{event.data.images}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{event.data.images}}"></image>
            </view>
          </view>
          
          <!-- BANDING事件的数据 -->
          <view class="info-item" wx:if="{{event.type === 'BANDING' && event.data.recyclerNickname}}">
            <text class="info-label">回收员：</text>
            <text class="info-value">{{event.data.recyclerNickname}}</text>
          </view>
          
          <!-- RECYCLING事件的数据 -->
          <view class="info-item" wx:if="{{event.type === 'RECYCLING' && event.data.weight}}">
            <text class="info-label">实际重量：</text>
            <text class="info-value">{{event.data.weight}}kg</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'RECYCLING' && event.data.price}}">
            <text class="info-label">回收价格：</text>
            <text class="info-value price">￥{{event.data.price}}</text>
          </view>
          
          <!-- 价格组成信息（RECYCLING事件） -->
          <view class="price-breakdown" wx:if="{{event.type === 'RECYCLING' && event.data.recyclingPricePerKg}}">
            <view class="breakdown-title">价格组成</view>
            <view class="breakdown-item">
              <text class="breakdown-label">回收价：</text>
              <text class="breakdown-value">￥{{event.data.recyclingPricePerKg}}/kg</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.baseAmount}}">
              <text class="breakdown-label">基础金额：</text>
              <text class="breakdown-value">￥{{event.data.baseAmount}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.overtimeCompensation > 0}}">
              <text class="breakdown-label">超时补偿：</text>
              <text class="breakdown-value positive">+￥{{event.data.overtimeCompensation}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.urgentFee > 0}}">
              <text class="breakdown-label">加急费用：</text>
              <text class="breakdown-value negative">-￥{{event.data.urgentFee}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.urgentFeeZeroReason}}">
              <text class="breakdown-label">加急费用说明：</text>
              <text class="breakdown-value reason">{{event.data.urgentFeeZeroReason}}</text>
            </view>
          </view>
          
          <view class="info-item" wx:if="{{event.type === 'RECYCLING' && event.data.images && event.data.images.length > 0}}">
            <text class="info-label">回收照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{event.data.images}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{event.data.images}}"></image>
            </view>
          </view>
          
          <!-- OFFLINE_SETTLEMENT事件的数据（线下结算完成） -->
          <view class="info-item" wx:if="{{event.type === 'OFFLINE_SETTLEMENT' && event.data.weight}}">
            <text class="info-label">实际重量：</text>
            <text class="info-value">{{event.data.weight}}kg</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'OFFLINE_SETTLEMENT' && event.data.price}}">
            <text class="info-label">结算金额：</text>
            <text class="info-value price">￥{{event.data.price}}</text>
          </view>
          
          <!-- 价格组成信息（OFFLINE_SETTLEMENT事件） -->
          <view class="price-breakdown" wx:if="{{event.type === 'OFFLINE_SETTLEMENT' && event.data.recyclingPricePerKg}}">
            <view class="breakdown-title">价格组成</view>
            <view class="breakdown-item">
              <text class="breakdown-label">回收价：</text>
              <text class="breakdown-value">￥{{event.data.recyclingPricePerKg}}/kg</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.baseAmount}}">
              <text class="breakdown-label">基础金额：</text>
              <text class="breakdown-value">￥{{event.data.baseAmount}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.overtimeCompensation > 0}}">
              <text class="breakdown-label">超时补偿：</text>
              <text class="breakdown-value positive">+￥{{event.data.overtimeCompensation}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.urgentFee > 0}}">
              <text class="breakdown-label">加急费用：</text>
              <text class="breakdown-value negative">-￥{{event.data.urgentFee}}</text>
            </view>
            <view class="breakdown-item" wx:if="{{event.data.urgentFeeZeroReason}}">
              <text class="breakdown-label">加急费用说明：</text>
              <text class="breakdown-value reason">{{event.data.urgentFeeZeroReason}}</text>
            </view>
          </view>
          
          <view class="info-item" wx:if="{{event.type === 'OFFLINE_SETTLEMENT' && event.data.images && event.data.images.length > 0}}">
            <text class="info-label">回收照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{event.data.images}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{event.data.images}}"></image>
            </view>
          </view>
          <view class="info-item" wx:if="{{event.type === 'OFFLINE_SETTLEMENT' && event.data.settlementImage && event.data.settlementImage.length > 0}}">
            <text class="info-label">结算照片：</text>
            <view class="image-list">
              <image class="info-image" 
                     wx:for="{{event.data.settlementImage}}" 
                     wx:key="*this"
                     src="{{item}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item}}"
                     data-urls="{{event.data.settlementImage}}"></image>
            </view>
          </view>
          
          <!-- PAYMENT事件的数据（打款完成） -->
          <view class="info-item" wx:if="{{event.type === 'PAYMENT' && event.data.amount}}">
            <text class="info-label">打款金额：</text>
            <text class="info-value price">￥{{event.data.amount}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'PAYMENT' && event.data.paymentTime}}">
            <text class="info-label">打款时间：</text>
            <text class="info-value">{{event.data.paymentTime}}</text>
          </view>
          
          <!-- TRANSFER事件的数据（转单） -->
          <view class="info-item" wx:if="{{event.type === 'TRANSFER' && event.data.fromRecyclerNickname}}">
            <text class="info-label">原回收员：</text>
            <text class="info-value">{{event.data.fromRecyclerNickname}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'TRANSFER' && event.data.toRecyclerNickname}}">
            <text class="info-label">新回收员：</text>
            <text class="info-value">{{event.data.toRecyclerNickname}}</text>
          </view>
          <view class="info-item" wx:if="{{event.type === 'TRANSFER' && event.data.reason}}">
            <text class="info-label">转单原因：</text>
            <text class="info-value">{{event.data.reason}}</text>
          </view>
          
          <!-- CANCEL / ADMIN_CANCEL 事件的数据 -->
          <view class="info-item" wx:if="{{(event.type === 'CANCEL' || event.type === 'ADMIN_CANCEL') && event.data.reason}}">
            <text class="info-label">取消原因：</text>
            <text class="info-value">{{event.data.reason}}</text>
          </view>
        </view>
      </view>
    </view>
    </view>
  </scroll-view>

  <!-- 操作按钮区域 -->
  <view class="actions-bar" wx:if="{{orderDetail.allowedActions && orderDetail.allowedActions.length > 0}}">
    <button 
      wx:for="{{orderDetail.allowedActions}}" 
      wx:key="*this"
      class="action-btn cancel-btn"
      bindtap="handleAction"
      data-action="{{item}}"
    >
      {{item === 'CANCEL' ? '取消订单' : item}}
    </button>
  </view>
</view>

<view class="loading" wx:if="{{loading}}">
  <text>加载中...</text>
</view>

