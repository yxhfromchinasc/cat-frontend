# 微信小程序手机号解密接口协议

## 接口信息

- **接口路径**: `/api/user/decrypt-phone`
- **请求方法**: `POST`
- **接口描述**: 解密微信小程序加密的手机号数据
- **权限要求**: 无需登录（公开接口）

## 请求参数

### 请求头
```http
Content-Type: application/json
```

### 请求体
```json
{
  "encryptedData": "string",  // 必填，微信小程序返回的加密数据
  "iv": "string",             // 必填，微信小程序返回的加密向量
  "code": "string"            // 必填，微信小程序授权码
}
```

### 参数说明

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| encryptedData | string | 是 | 微信小程序 `wx.getPhoneNumber` 返回的 `encryptedData` |
| iv | string | 是 | 微信小程序 `wx.getPhoneNumber` 返回的 `iv` |
| code | string | 是 | 微信小程序 `wx.login` 返回的授权码，用于获取 session_key |

## 响应格式

### 成功响应
```json
{
  "success": true,
  "code": 200,
  "message": "解密成功",
  "data": {
    "phone": "13800138000"  // 解密后的手机号
  }
}
```

### 失败响应
```json
{
  "success": false,
  "code": 400,
  "message": "解密失败，请重试",
  "data": null
}
```

## 错误码说明

| 错误码 | 描述 | 处理建议 |
|--------|------|----------|
| 200 | 解密成功 | 正常处理 |
| 400 | 请求参数错误或解密失败 | 提示用户重试 |
| 500 | 服务器内部错误 | 提示用户稍后重试 |

## 实现要点

### 1. 解密算法
- 使用微信小程序提供的解密算法
- 需要配置微信小程序的 `AppSecret`
- 使用 AES-128-CBC 解密算法
- 通过 `code` 参数获取 `session_key` 进行解密

### 2. 安全考虑
- 验证 `encryptedData`、`iv` 和 `code` 的格式
- 设置合理的请求频率限制
- 记录解密日志（不记录敏感信息）
- 验证 `code` 的有效性，防止重放攻击

### 3. 返回数据
- 只返回解密后的手机号
- 不返回其他敏感信息
- 手机号格式验证

## 示例代码

### 前端调用示例
```javascript
// 在 login.js 中的调用
const decryptResult = await api.decryptPhoneNumber(e.detail.encryptedData, e.detail.iv)
```

### 后端实现参考
```java
@PostMapping("/decrypt-phone")
public Result<DecryptPhoneResp> decryptPhoneNumber(@RequestBody DecryptPhoneReq request) {
    try {
        // 1. 参数验证
        if (StringUtils.isEmpty(request.getEncryptedData()) || 
            StringUtils.isEmpty(request.getIv()) ||
            StringUtils.isEmpty(request.getCode())) {
            return Result.error(400, "请求参数错误");
        }
        
        // 2. 通过 code 获取 session_key
        String sessionKey = WeChatUtils.getSessionKey(request.getCode());
        if (StringUtils.isEmpty(sessionKey)) {
            return Result.error(400, "获取session_key失败");
        }
        
        // 3. 解密手机号
        String phone = WeChatUtils.decryptPhoneNumber(
            request.getEncryptedData(), 
            request.getIv(),
            sessionKey
        );
        
        // 4. 返回结果
        DecryptPhoneResp response = new DecryptPhoneResp();
        response.setPhone(phone);
        return Result.success(response);
        
    } catch (Exception e) {
        log.error("手机号解密失败", e);
        return Result.error(400, "解密失败，请重试");
    }
}
```

## 测试用例

### 正常情况
```json
// 请求
{
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZM...",
  "iv": "r7BXXKkLb8qrSNn05n0qiA==",
  "code": "081234567890abcdef"
}

// 响应
{
  "success": true,
  "code": 200,
  "message": "解密成功",
  "data": {
    "phone": "13800138000"
  }
}
```

### 参数错误
```json
// 请求
{
  "encryptedData": "",
  "iv": "r7BXXKkLb8qrSNn05n0qiA==",
  "code": "081234567890abcdef"
}

// 响应
{
  "success": false,
  "code": 400,
  "message": "请求参数错误",
  "data": null
}
```

### code无效
```json
// 请求
{
  "encryptedData": "CiyLU1Aw2KjvrjMdj8YKliAjtP4gsMZM...",
  "iv": "r7BXXKkLb8qrSNn05n0qiA==",
  "code": "invalid_code"
}

// 响应
{
  "success": false,
  "code": 400,
  "message": "获取session_key失败",
  "data": null
}
```

## 注意事项

1. **微信小程序配置**: 确保后端配置了正确的微信小程序 `AppSecret`
2. **解密算法**: 使用微信官方提供的解密算法
3. **错误处理**: 提供友好的错误提示
4. **日志记录**: 记录解密请求，但不记录敏感数据
5. **性能优化**: 考虑解密操作的性能影响
6. **code 使用限制**: `code` 只能使用一次，使用后立即失效
7. **时序要求**: 手机号授权和解密必须在 `code` 有效期内完成

## 相关文档

- [微信小程序获取手机号](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html)
- [微信小程序数据解密](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html)

## 更新日志

- **2024-01-20**: 创建接口协议文档
- **版本**: v1.0.0
